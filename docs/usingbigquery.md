# Visual Inspection AI Edge Solution

# Using the solution

## Streaming inference results to BigQuery

This solution has an example GCP backend for archiving the ML inference results, and to be able to run analytics on the results to for example compare ML model performance over across versions and time. 

The example backend consists of the following pre-configured services:

* Cloud Pub/Sub for receiving ML inference results. The payload is the JSON results from the VIAI model container, with additional metadata: 
  * Camera device ID
  * Timestamp of the ML inference execution in RFC3339 format
  * File ID of the inference. This ID can be used to match the ML inference results row in BigQuery with the image file names generated by the camera client - if the client was configured to write, or upload images as files
* Cloud Function to subscribe to the messages in Pub/Sub and write them to BigQuery
* BigQuery dataset for the solution and a destination table for the ML inference results

To use the inference results cloud backend, add the following switches to the camera integration app when running it:
* `--pubsub results` activates streaming the ML results JSON to Pub/Sub
* `--project_id` the GCP project ID for the backend
* `--credentials` pointing to the service account JSON key which has been authorized to publish messages to Pub/Sub

To run the camera client with the Pub/Sub streaming option, run:

```bash
export ML_HOST=viai-model
export PROJECT_ID=<YOUR GCP PROJECT ID>

python3 camera_client.py --protocol genicam --gentl /var/lib/viai/camera-config/FLIR_GenTL_Ubuntu_20_04_x86_64.cti \
    --cfg_write --cfg_write_file ./flir-ax5-recommended.cfg --device_id ax5  --mode continuous --ml --ml_host ${ML_HOST} \
    --ml_port 8602 --pubsub results --project_id ${PROJECT_ID} --count 1 
```

The command output should now contain the following lines, showing the inference results transmission to Pub/Sub:

```
Passing camera images to the ML model container
{'predictionResult': â€¦ 'annotationSpecDisplayName': 'defect'}]}]}, 'predictionLatency': '4.417044194s'}
Transmitting data to Cloud Pub/Sub
Closing camera connection and exiting
```

You can observe the payloads by monitoring:
* [Cloud Pub/Sub subscription](https://pantheon.corp.google.com/cloudpubsub/): `camera-integration-telemetry`
* [Cloud Functions function](https://pantheon.corp.google.com/functions): `pubsub_bigquery_inference_results`
* [BigQuery table](https://pantheon.corp.google.com/bigquery): `viai_edge.inference_results`



</br>

___

<table width="100%">
<tr><td><a href="./useviai.md">^^^ Using Visual Inspection AI Edge</td><td><a href="./usingmqtt.md">Streaming inference results to local MQTT for local actions >>></td></tr>
</table>



 